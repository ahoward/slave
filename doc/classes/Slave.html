<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: Slave</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href=".././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">Slave</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../files/lib/slave_rb.html">
                lib/slave.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                Object
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">
    <div id="diagram">
      <map id="map" name="map">
  <area shape="rect" coords="27,50,99,98"      href="Slave.html" alt="Slave" />
</map>
<img src="../dot/f_1.jpg" usemap="#map" border="0" alt="dot/f_1.jpg">
    </div>

    <div id="description">
      <p>
the <a href="Slave.html">Slave</a> class encapsulates the work of setting
up a drb server in another process running on localhost via unix domain
sockets. the slave process is attached to it&#8216;s parent via a <a
href="Slave/LifeLine.html">LifeLine</a> which is designed such that the
slave cannot out-live it&#8216;s parent and become a zombie, even if the
parent dies and early death, such as by &#8216;kill -9&#8217;. the concept
and purpose of the <a href="Slave.html">Slave</a> class is to be able to
setup any server <a href="Slave.html#M000015">object</a> in another process
so easily that using a multi-process, drb/ipc, based design is as easy, or
easier, than a multi-threaded one. eg
</p>
<pre>
  class Server
    def add_two n
      n + 2
    end
  end

  slave = Slave.new 'object' =&gt; Server.new
  server = slave.object

  p server.add_two(40) #=&gt; 42
</pre>
<p>
two other methods of providing server objects exist:
</p>
<p>
a) server = Server.new &quot;this is called the parent&quot; }
</p>
<pre>
   Slave.new(:object=&gt;server){|s| puts &quot;#{ s.inspect } passed to block in child process&quot;}
</pre>
<p>
b) <a href="Slave.html#M000005">Slave.new</a>{ Server.new &quot;this is
called only in the child&quot; }
</p>
<p>
of the two &#8216;b&#8217; is preferred.
</p>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000012">default</a>&nbsp;&nbsp;
      <a href="#M000002">default</a>&nbsp;&nbsp;
      <a href="#M000006">detach</a>&nbsp;&nbsp;
      <a href="#M000004">fork</a>&nbsp;&nbsp;
      <a href="#M000011">gen_psname</a>&nbsp;&nbsp;
      <a href="#M000003">getopts</a>&nbsp;&nbsp;
      <a href="#M000013">getopts</a>&nbsp;&nbsp;
      <a href="#M000005">new</a>&nbsp;&nbsp;
      <a href="#M000015">object</a>&nbsp;&nbsp;
      <a href="#M000009">shutdown</a>&nbsp;&nbsp;
      <a href="#M000010">shutdown?</a>&nbsp;&nbsp;
      <a href="#M000014">trace</a>&nbsp;&nbsp;
      <a href="#M000001">version</a>&nbsp;&nbsp;
      <a href="#M000007">wait</a>&nbsp;&nbsp;
      <a href="#M000008">wait2</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">

    <div id="class-list">
      <h3 class="section-bar">Classes and Modules</h3>

      Class <a href="Slave/LifeLine.html" class="link">Slave::LifeLine</a><br />
Class <a href="Slave/ThreadSafe.html" class="link">Slave::ThreadSafe</a><br />
Class <a href="Slave/ThreadSafeHash.html" class="link">Slave::ThreadSafeHash</a><br />

    </div>

    <div id="constants-list">
      <h3 class="section-bar">Constants</h3>

      <div class="name-list">
        <table summary="Constants">
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">VERSION</td>
          <td>=</td>
          <td class="context-item-value">'1.2.1'</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">DEFAULT_SOCKET_CREATION_ATTEMPTS</td>
          <td>=</td>
          <td class="context-item-value">Integer(ENV['SLAVE_SOCKET_CREATION_ATTEMPTS'] || 42)</td>
          <td width="3em">&nbsp;</td>
          <td class="context-item-desc">
env config

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">DEFAULT_DEBUG</td>
          <td>=</td>
          <td class="context-item-value">(ENV['SLAVE_DEBUG'] ? true : false)</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">DEFAULT_THREADSAFE</td>
          <td>=</td>
          <td class="context-item-value">(ENV['SLAVE_THREADSAFE'] ? true : false)</td>
        </tr>
        </table>
      </div>
    </div>



    <div id="attribute-list">
      <h3 class="section-bar">Attributes</h3>

      <div class="name-list">
        <table>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">at_exit</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">debug</td>
          <td class="context-item-value">&nbsp;[RW]&nbsp;</td>
          <td class="context-item-desc">
if this is true and you are running from a terminal information is printed
on STDERR

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">debug</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">dumped</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">obj</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
attrs

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">object</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">pid</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">ppid</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">psname</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">socket</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">socket_creation_attempts</td>
          <td class="context-item-value">&nbsp;[RW]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">socket_creation_attempts</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">status</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">threadsafe</td>
          <td class="context-item-value">&nbsp;[RW]&nbsp;</td>
          <td class="context-item-desc">
if this is true all slave objects will be wrapped such that any call to the
<a href="Slave.html#M000015">object</a> is threadsafe. if you do not use
this you must ensure that your objects are threadsafe <em>yourself</em> as
this is required of any <a href="Slave.html#M000015">object</a> acting as a
drb server

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">uri</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        </table>
      </div>
    </div>
      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000002" class="method-detail">
        <a name="M000002"></a>

        <div class="method-heading">
          <a href="#M000002" class="method-signature">
          <span class="method-name">default</span><span class="method-args">(key)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
get a <a href="Slave.html#M000002">default</a> value
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000002-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000002-source">
<pre>
    <span class="ruby-comment cmt"># File lib/slave.rb, line 77</span>
77:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">default</span> <span class="ruby-identifier">key</span>
78: <span class="ruby-comment cmt">#--{{{</span>
79:         <span class="ruby-identifier">send</span> <span class="ruby-identifier">key</span>
80: <span class="ruby-comment cmt">#--}}}</span>
81:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000004" class="method-detail">
        <a name="M000004"></a>

        <div class="method-heading">
          <a href="#M000004" class="method-signature">
          <span class="method-name">fork</span><span class="method-args">(&amp;b)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
just <a href="Slave.html#M000004">fork</a> with out silly warnings
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000004-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000004-source">
<pre>
     <span class="ruby-comment cmt"># File lib/slave.rb, line 98</span>
 98:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">fork</span> <span class="ruby-operator">&amp;</span><span class="ruby-identifier">b</span>
 99: <span class="ruby-comment cmt">#--{{{</span>
100:         <span class="ruby-identifier">v</span> = <span class="ruby-identifier">$VERBOSE</span>
101:         <span class="ruby-keyword kw">begin</span>
102:           <span class="ruby-identifier">$VERBOSE</span> = <span class="ruby-keyword kw">nil</span>
103:           <span class="ruby-constant">Process</span><span class="ruby-operator">::</span><span class="ruby-identifier">fork</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">b</span>)
104:         <span class="ruby-keyword kw">ensure</span>
105:         <span class="ruby-identifier">$VERBOSE</span> = <span class="ruby-identifier">v</span>
106:         <span class="ruby-keyword kw">end</span>
107: <span class="ruby-comment cmt">#--}}}</span>
108:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000003" class="method-detail">
        <a name="M000003"></a>

        <div class="method-heading">
          <a href="#M000003" class="method-signature">
          <span class="method-name">getopts</span><span class="method-args">(opts)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000003-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000003-source">
<pre>
    <span class="ruby-comment cmt"># File lib/slave.rb, line 83</span>
83:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">getopts</span> <span class="ruby-identifier">opts</span>
84: <span class="ruby-comment cmt">#--{{{</span>
85:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">class</span> <span class="ruby-keyword kw">unless</span>
86:           <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value str">'has_key?'</span>) <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value str">'[]'</span>)
87: 
88:         <span class="ruby-identifier">lambda</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">defval</span><span class="ruby-operator">|</span>
89:           <span class="ruby-identifier">defval</span> = <span class="ruby-identifier">defval</span>.<span class="ruby-identifier">shift</span>
90:           <span class="ruby-identifier">keys</span> = [<span class="ruby-identifier">key</span>, <span class="ruby-identifier">key</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-identifier">key</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">intern</span>]
91:           <span class="ruby-identifier">key</span> = <span class="ruby-identifier">keys</span>.<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">k</span><span class="ruby-operator">|</span> <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">has_key?</span> <span class="ruby-identifier">k</span> } <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">break</span> <span class="ruby-identifier">opts</span>[<span class="ruby-identifier">key</span>]
92:           <span class="ruby-identifier">defval</span>
93:         <span class="ruby-keyword kw">end</span>
94: <span class="ruby-comment cmt">#--}}}</span>
95:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000005" class="method-detail">
        <a name="M000005"></a>

        <div class="method-heading">
          <a href="#M000005" class="method-signature">
          <span class="method-name">new</span><span class="method-args">(opts = {})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
sets up a child process serving any <a href="Slave.html#M000015">object</a>
as a DRb server running locally on unix domain sockets. the child process
has a <a href="Slave/LifeLine.html">LifeLine</a> established between it and
the parent, making it impossible for the child to outlive the parent
(become a zombie). the <a href="Slave.html#M000015">object</a> to serve is
specfied either directly using the &#8216;<a
href="Slave.html#M000015">object</a>&#8217;/:<a
href="Slave.html#M000015">object</a> keyword
</p>
<pre>
  Slave.new :object =&gt; MyServer.new
</pre>
<p>
or, preferably, using the block form
</p>
<pre>
  Slave.new{ MyServer.new }
</pre>
<p>
when the block form is used the <a href="Slave.html#M000015">object</a> is
contructed in the child process itself. this is quite advantageous if the
child <a href="Slave.html#M000015">object</a> consumes resources or opens
file handles (db connections, etc). by contructing the <a
href="Slave.html#M000015">object</a> in the child any resources are
consumed from the child&#8216;s address space and things like open file
handles will not be carried into subsequent child processes (via standard
unix <a href="Slave.html#M000004">fork</a> semantics). in the event that a
block is specified but the <a href="Slave.html#M000015">object</a> cannot
be constructed and, instead, throws and Exception, that exception will be
propogated to the parent process.
</p>
<p>
opts may contain the following keys, as either strings or symbols
</p>
<pre>
  object : specify the slave object.  otherwise block value is used.
  socket_creation_attempts : specify how many attempts to create a unix domain socket will be made
  debug : turn on some logging to STDERR
  psname : specify the name that will appear in 'top' ($0)
  at_exit : specify a lambda to be called in the *parent* when the child dies
  dumped : specify that the slave object should *not* be DRbUndumped (default is DRbUndumped)
  threadsafe : wrap the slave object with ThreadSafe to implement gross thread safety
</pre>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000005-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000005-source">
<pre>
     <span class="ruby-comment cmt"># File lib/slave.rb, line 319</span>
319:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span> <span class="ruby-identifier">opts</span> = {}, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>
320: <span class="ruby-comment cmt">#--{{{</span>
321:       <span class="ruby-identifier">getopt</span> = <span class="ruby-identifier">getopts</span> <span class="ruby-identifier">opts</span>
322: 
323:       <span class="ruby-ivar">@obj</span> = <span class="ruby-identifier">getopt</span>[<span class="ruby-value str">'object'</span>]
324:       <span class="ruby-ivar">@socket_creation_attempts</span> = <span class="ruby-identifier">getopt</span>[<span class="ruby-value str">'socket_creation_attempts'</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">default</span>(<span class="ruby-value str">'socket_creation_attempts'</span>)
325:       <span class="ruby-ivar">@debug</span> = <span class="ruby-identifier">getopt</span>[<span class="ruby-value str">'debug'</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">default</span>(<span class="ruby-value str">'debug'</span>)
326:       <span class="ruby-ivar">@psname</span> = <span class="ruby-identifier">getopt</span>[<span class="ruby-value str">'psname'</span>]
327:       <span class="ruby-ivar">@at_exit</span> = <span class="ruby-identifier">getopt</span>[<span class="ruby-value str">'at_exit'</span>]
328:       <span class="ruby-ivar">@dumped</span> = <span class="ruby-identifier">getopt</span>[<span class="ruby-value str">'dumped'</span>]
329:       <span class="ruby-ivar">@threadsafe</span> = <span class="ruby-identifier">getopt</span>[<span class="ruby-value str">'threadsafe'</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">default</span>(<span class="ruby-value str">'threadsafe'</span>)
330: 
331:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-value str">'no slave object or slave object block provided!'</span> <span class="ruby-keyword kw">if</span> 
332:         <span class="ruby-ivar">@obj</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">block</span>.<span class="ruby-identifier">nil?</span>
333: 
334:       <span class="ruby-ivar">@shutdown</span> = <span class="ruby-keyword kw">false</span>
335:       <span class="ruby-ivar">@waiter</span> = <span class="ruby-ivar">@status</span> = <span class="ruby-keyword kw">nil</span>
336:       <span class="ruby-ivar">@lifeline</span> = <span class="ruby-constant">LifeLine</span>.<span class="ruby-identifier">new</span>
337: 
338:       <span class="ruby-comment cmt"># weird syntax because dot/rdoc chokes on this!?!?</span>
339:       <span class="ruby-identifier">init_failure</span> = <span class="ruby-identifier">lambda</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">e</span><span class="ruby-operator">|</span>
340:         <span class="ruby-identifier">trace</span>{ <span class="ruby-node">%Q[#{ e.message } (#{ e.class })\n#{ e.backtrace.join &quot;\n&quot; }]</span> }
341:         <span class="ruby-identifier">o</span> = <span class="ruby-constant">Object</span>.<span class="ruby-identifier">new</span>
342:         <span class="ruby-keyword kw">class</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">o</span>
343:           <span class="ruby-identifier">attr_accessor</span> <span class="ruby-value str">'__slave_object_failure__'</span>
344:         <span class="ruby-keyword kw">end</span>
345:         <span class="ruby-identifier">o</span>.<span class="ruby-identifier">__slave_object_failure__</span> = <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">dump</span> [<span class="ruby-identifier">e</span>.<span class="ruby-identifier">class</span>, <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span>, <span class="ruby-identifier">e</span>.<span class="ruby-identifier">backtrace</span>]
346:         <span class="ruby-ivar">@object</span> = <span class="ruby-identifier">o</span>
347:       <span class="ruby-keyword kw">end</span>
348: 
349:     <span class="ruby-comment cmt">#</span>
350:     <span class="ruby-comment cmt"># child</span>
351:     <span class="ruby-comment cmt">#</span>
352:       <span class="ruby-keyword kw">unless</span>((<span class="ruby-ivar">@pid</span> = <span class="ruby-constant">Slave</span><span class="ruby-operator">::</span><span class="ruby-identifier">fork</span>))
353:         <span class="ruby-identifier">e</span> = <span class="ruby-keyword kw">nil</span>
354:         <span class="ruby-keyword kw">begin</span>
355:           <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">at_exit</span>{ <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">exit!</span> }
356:           <span class="ruby-ivar">@lifeline</span>.<span class="ruby-identifier">catch</span>
357: 
358:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@obj</span>
359:             <span class="ruby-ivar">@object</span> = <span class="ruby-ivar">@obj</span>
360:           <span class="ruby-keyword kw">else</span>
361:             <span class="ruby-keyword kw">begin</span>
362:               <span class="ruby-ivar">@object</span> = <span class="ruby-identifier">block</span>.<span class="ruby-identifier">call</span> 
363:             <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
364:               <span class="ruby-identifier">init_failure</span>[<span class="ruby-identifier">e</span>]
365:             <span class="ruby-keyword kw">end</span>
366:           <span class="ruby-keyword kw">end</span>
367: 
368:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">block</span> <span class="ruby-keyword kw">and</span> <span class="ruby-ivar">@obj</span>
369:             <span class="ruby-keyword kw">begin</span>
370:               <span class="ruby-identifier">block</span>[<span class="ruby-ivar">@obj</span>]
371:             <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
372:               <span class="ruby-identifier">init_failure</span>[<span class="ruby-identifier">e</span>]
373:             <span class="ruby-keyword kw">end</span>
374:           <span class="ruby-keyword kw">end</span>
375: 
376:           <span class="ruby-identifier">$0</span> = (<span class="ruby-ivar">@psname</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">gen_psname</span>(<span class="ruby-ivar">@object</span>))
377: 
378:           <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@dumped</span> <span class="ruby-keyword kw">or</span> <span class="ruby-ivar">@object</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value str">'__slave_object_failure__'</span>)
379:             <span class="ruby-ivar">@object</span>.<span class="ruby-identifier">extend</span> <span class="ruby-constant">DRbUndumped</span>
380:           <span class="ruby-keyword kw">end</span>
381: 
382:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@threadsafe</span>
383:             <span class="ruby-ivar">@object</span> = <span class="ruby-constant">ThreadSafe</span>.<span class="ruby-identifier">new</span> <span class="ruby-ivar">@object</span>
384:           <span class="ruby-keyword kw">end</span>
385: 
386:           <span class="ruby-ivar">@ppid</span>, <span class="ruby-ivar">@pid</span> = <span class="ruby-constant">Process</span><span class="ruby-operator">::</span><span class="ruby-identifier">ppid</span>, <span class="ruby-constant">Process</span><span class="ruby-operator">::</span><span class="ruby-identifier">pid</span>
387:           <span class="ruby-ivar">@socket</span> = <span class="ruby-keyword kw">nil</span>
388:           <span class="ruby-ivar">@uri</span> = <span class="ruby-keyword kw">nil</span>
389: 
390:           <span class="ruby-identifier">tmpdir</span>, <span class="ruby-identifier">basename</span> = <span class="ruby-constant">Dir</span><span class="ruby-operator">::</span><span class="ruby-identifier">tmpdir</span>, <span class="ruby-constant">File</span><span class="ruby-operator">::</span><span class="ruby-identifier">basename</span>(<span class="ruby-ivar">@psname</span>)
391: 
392:           <span class="ruby-ivar">@socket_creation_attempts</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">attempt</span><span class="ruby-operator">|</span>
393:             <span class="ruby-identifier">se</span> = <span class="ruby-keyword kw">nil</span>
394:             <span class="ruby-keyword kw">begin</span>
395:               <span class="ruby-identifier">s</span> = <span class="ruby-constant">File</span><span class="ruby-operator">::</span><span class="ruby-identifier">join</span>(<span class="ruby-identifier">tmpdir</span>, <span class="ruby-node">&quot;#{ basename }_#{ attempt }_#{ rand }&quot;</span>)
396:               <span class="ruby-identifier">u</span> = <span class="ruby-node">&quot;drbunix://#{ s }&quot;</span>
397:               <span class="ruby-constant">DRb</span><span class="ruby-operator">::</span><span class="ruby-identifier">start_service</span> <span class="ruby-identifier">u</span>, <span class="ruby-ivar">@object</span> 
398:               <span class="ruby-ivar">@socket</span> = <span class="ruby-identifier">s</span>
399:               <span class="ruby-ivar">@uri</span> = <span class="ruby-identifier">u</span>
400:               <span class="ruby-identifier">trace</span>{ <span class="ruby-node">&quot;child - socket &lt;#{ @socket }&gt;&quot;</span> }
401:               <span class="ruby-identifier">trace</span>{ <span class="ruby-node">&quot;child - uri &lt;#{ @uri }&gt;&quot;</span> }
402:               <span class="ruby-keyword kw">break</span>
403:             <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">EADDRINUSE</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">se</span>
404:               <span class="ruby-keyword kw">nil</span>
405:             <span class="ruby-keyword kw">end</span>
406:           <span class="ruby-keyword kw">end</span>
407: 
408:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@socket</span> <span class="ruby-keyword kw">and</span> <span class="ruby-ivar">@uri</span>
409:             <span class="ruby-identifier">trap</span>(<span class="ruby-value str">'SIGUSR2'</span>) <span class="ruby-keyword kw">do</span>
410:               <span class="ruby-constant">DBb</span><span class="ruby-operator">::</span><span class="ruby-identifier">thread</span>.<span class="ruby-identifier">kill</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
411:               <span class="ruby-constant">FileUtils</span><span class="ruby-operator">::</span><span class="ruby-identifier">rm_f</span> <span class="ruby-ivar">@socket</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
412:               <span class="ruby-identifier">exit</span>
413:             <span class="ruby-keyword kw">end</span>
414: 
415:             <span class="ruby-ivar">@lifeline</span>.<span class="ruby-identifier">puts</span> <span class="ruby-ivar">@socket</span> 
416:             <span class="ruby-ivar">@lifeline</span>.<span class="ruby-identifier">cling</span>
417:           <span class="ruby-keyword kw">else</span>
418:             <span class="ruby-ivar">@lifeline</span>.<span class="ruby-identifier">release</span>
419:             <span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;slave(#{ $$ }) could not create socket!&quot;</span>
420:             <span class="ruby-identifier">exit</span>
421:           <span class="ruby-keyword kw">end</span>
422:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
423:           <span class="ruby-identifier">trace</span>{ <span class="ruby-node">%Q[#{ e.message } (#{ e.class })\n#{ e.backtrace.join &quot;\n&quot; }]</span> }
424:         <span class="ruby-keyword kw">ensure</span>
425:           <span class="ruby-identifier">status</span> = <span class="ruby-identifier">e</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value str">'status'</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">:</span> <span class="ruby-value">1</span>
426:           <span class="ruby-identifier">exit</span>(<span class="ruby-identifier">status</span>)
427:         <span class="ruby-keyword kw">end</span>
428:     <span class="ruby-comment cmt">#</span>
429:     <span class="ruby-comment cmt"># parent </span>
430:     <span class="ruby-comment cmt">#</span>
431:       <span class="ruby-keyword kw">else</span>
432:         <span class="ruby-identifier">detach</span>
433:         <span class="ruby-ivar">@lifeline</span>.<span class="ruby-identifier">throw</span>
434: 
435:         <span class="ruby-identifier">buf</span> = <span class="ruby-ivar">@lifeline</span>.<span class="ruby-identifier">gets</span>
436:         <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;failed to find slave socket&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">buf</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">buf</span>.<span class="ruby-identifier">strip</span>.<span class="ruby-identifier">empty?</span>
437:         <span class="ruby-ivar">@socket</span> = <span class="ruby-identifier">buf</span>.<span class="ruby-identifier">strip</span>
438:         <span class="ruby-identifier">trace</span>{ <span class="ruby-node">&quot;parent - socket &lt;#{ @socket }&gt;&quot;</span> }
439: 
440:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@at_exit</span>
441:           <span class="ruby-ivar">@at_exit_thread</span> = <span class="ruby-ivar">@lifeline</span>.<span class="ruby-identifier">on_cut</span>{ 
442:             <span class="ruby-ivar">@at_exit</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value str">'call'</span>) <span class="ruby-operator">?</span> <span class="ruby-ivar">@at_exit</span>.<span class="ruby-identifier">call</span>(<span class="ruby-keyword kw">self</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">send</span>(<span class="ruby-ivar">@at_exit</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-keyword kw">self</span>)
443:           }
444:         <span class="ruby-keyword kw">end</span>
445: 
446:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@socket</span> <span class="ruby-keyword kw">and</span> <span class="ruby-constant">File</span><span class="ruby-operator">::</span><span class="ruby-identifier">exist?</span> <span class="ruby-ivar">@socket</span>
447:           <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">at_exit</span>{ <span class="ruby-constant">FileUtils</span><span class="ruby-operator">::</span><span class="ruby-identifier">rm_f</span> <span class="ruby-ivar">@socket</span> }
448:           <span class="ruby-ivar">@uri</span> = <span class="ruby-node">&quot;drbunix://#{ socket }&quot;</span>
449:           <span class="ruby-identifier">trace</span>{ <span class="ruby-node">&quot;parent - uri &lt;#{ @uri }&gt;&quot;</span> }
450:         <span class="ruby-comment cmt">#</span>
451:         <span class="ruby-comment cmt"># starting drb on localhost avoids dns lookups!</span>
452:         <span class="ruby-comment cmt">#</span>
453:           <span class="ruby-constant">DRb</span><span class="ruby-operator">::</span><span class="ruby-identifier">start_service</span>(<span class="ruby-value str">'druby://localhost:0'</span>, <span class="ruby-keyword kw">nil</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">DRb</span><span class="ruby-operator">::</span><span class="ruby-identifier">thread</span>
454:           <span class="ruby-ivar">@object</span> = <span class="ruby-constant">DRbObject</span><span class="ruby-operator">::</span><span class="ruby-identifier">new</span> <span class="ruby-keyword kw">nil</span>, <span class="ruby-ivar">@uri</span>
455:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@object</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-value str">'__slave_object_failure__'</span>
456:             <span class="ruby-identifier">c</span>, <span class="ruby-identifier">m</span>, <span class="ruby-identifier">bt</span> = <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">load</span> <span class="ruby-ivar">@object</span>.<span class="ruby-identifier">__slave_object_failure__</span>
457:             (<span class="ruby-identifier">e</span> = <span class="ruby-identifier">c</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">m</span>)).<span class="ruby-identifier">set_backtrace</span> <span class="ruby-identifier">bt</span>
458:             <span class="ruby-identifier">trace</span>{ <span class="ruby-node">%Q[#{ e.message } (#{ e.class })\n#{ e.backtrace.join &quot;\n&quot; }]</span> }
459:             <span class="ruby-identifier">raise</span> <span class="ruby-identifier">e</span> 
460:           <span class="ruby-keyword kw">end</span>
461:           <span class="ruby-ivar">@psname</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">gen_psname</span>(<span class="ruby-ivar">@object</span>)
462:         <span class="ruby-keyword kw">else</span>
463:           <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;failed to find slave socket &lt;#{ @socket }&gt;&quot;</span>
464:         <span class="ruby-keyword kw">end</span>
465:       <span class="ruby-keyword kw">end</span>
466: <span class="ruby-comment cmt">#--}}}</span>
467:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000015" class="method-detail">
        <a name="M000015"></a>

        <div class="method-heading">
          <a href="#M000015" class="method-signature">
          <span class="method-name">object</span><span class="method-args">(opts = {})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
a simple convenience method which returns an <b><a
href="Slave.html#M000015">object</a></b> from another process. the <a
href="Slave.html#M000015">object</a> returned is the result of the supplied
block. eg
</p>
<pre>
  object = Slave.object{ processor_intensive_object_built_in_child_process() }
</pre>
<p>
eg.
</p>
<p>
the call can be made asynchronous via the &#8216;async&#8217;/:async
keyword
</p>
<pre>
  thread = Slave.object(:async=&gt;true){ long_processor_intensive_object_built_in_child_process() }

  # go on about your coding business then, later

  object = thread.value
</pre>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000015-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000015-source">
<pre>
     <span class="ruby-comment cmt"># File lib/slave.rb, line 587</span>
587:     <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">object</span> <span class="ruby-identifier">opts</span> = {}, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">b</span>
588: <span class="ruby-comment cmt">#--{{{</span>
589:       <span class="ruby-identifier">async</span> = <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-value str">'async'</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">:async</span>) 
590: 
591:       <span class="ruby-identifier">opts</span>[<span class="ruby-value str">'object'</span>] = <span class="ruby-identifier">opts</span>[<span class="ruby-identifier">:object</span>] = <span class="ruby-identifier">lambda</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">b</span>)
592:       <span class="ruby-identifier">opts</span>[<span class="ruby-value str">'dumped'</span>] = <span class="ruby-identifier">opts</span>[<span class="ruby-identifier">:dumped</span>] = <span class="ruby-keyword kw">true</span> 
593: 
594:       <span class="ruby-identifier">slave</span> = <span class="ruby-constant">Slave</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">opts</span>
595: 
596:       <span class="ruby-identifier">value</span> = <span class="ruby-identifier">lambda</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">slave</span><span class="ruby-operator">|</span>
597:         <span class="ruby-keyword kw">begin</span>
598:           <span class="ruby-identifier">slave</span>.<span class="ruby-identifier">object</span>.<span class="ruby-identifier">call</span>
599:         <span class="ruby-keyword kw">ensure</span>
600:           <span class="ruby-identifier">slave</span>.<span class="ruby-identifier">shutdown</span>
601:         <span class="ruby-keyword kw">end</span>
602:       <span class="ruby-keyword kw">end</span>
603: 
604:       <span class="ruby-identifier">async</span> <span class="ruby-value">? </span><span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span>{ <span class="ruby-identifier">value</span>[<span class="ruby-identifier">slave</span>] } <span class="ruby-operator">:</span> <span class="ruby-identifier">value</span>[<span class="ruby-identifier">slave</span>] 
605: <span class="ruby-comment cmt">#--}}}</span>
606:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000001" class="method-detail">
        <a name="M000001"></a>

        <div class="method-heading">
          <a href="#M000001" class="method-signature">
          <span class="method-name">version</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000001-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000001-source">
<pre>
    <span class="ruby-comment cmt"># File lib/slave.rb, line 44</span>
44:     <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">version</span>() <span class="ruby-constant">VERSION</span> <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000012" class="method-detail">
        <a name="M000012"></a>

        <div class="method-heading">
          <a href="#M000012" class="method-signature">
          <span class="method-name">default</span><span class="method-args">(key)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
see docs for <a href="Slave.html#M000002">Slave.default</a>
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000012-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000012-source">
<pre>
     <span class="ruby-comment cmt"># File lib/slave.rb, line 546</span>
546:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">default</span> <span class="ruby-identifier">key</span>
547: <span class="ruby-comment cmt">#--{{{</span>
548:       <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">default</span> <span class="ruby-identifier">key</span>
549: <span class="ruby-comment cmt">#--}}}</span>
550:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000006" class="method-detail">
        <a name="M000006"></a>

        <div class="method-heading">
          <a href="#M000006" class="method-signature">
          <span class="method-name">detach</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
starts a thread to collect the child status and sets up at_exit handler to
prevent zombies. the at_exit handler is canceled if the thread is able to
collect the status
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000006-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000006-source">
<pre>
     <span class="ruby-comment cmt"># File lib/slave.rb, line 473</span>
473:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">detach</span>
474: <span class="ruby-comment cmt">#--{{{</span>
475:       <span class="ruby-identifier">reap</span> = <span class="ruby-identifier">lambda</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">cid</span><span class="ruby-operator">|</span>
476:         <span class="ruby-keyword kw">begin</span>
477:           <span class="ruby-ivar">@status</span> = <span class="ruby-constant">Process</span><span class="ruby-operator">::</span><span class="ruby-identifier">waitpid2</span>(<span class="ruby-identifier">cid</span>).<span class="ruby-identifier">last</span>
478:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span> 
479:           <span class="ruby-identifier">m</span>, <span class="ruby-identifier">c</span>, <span class="ruby-identifier">b</span> = <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span>, <span class="ruby-identifier">e</span>.<span class="ruby-identifier">class</span>, <span class="ruby-identifier">e</span>.<span class="ruby-identifier">backtrace</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot;\n&quot;</span>)
480:           <span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;#{ m } (#{ c })\n#{ b }&quot;</span>  <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">is_a?</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ECHILD</span>
481:         <span class="ruby-keyword kw">end</span>
482:       <span class="ruby-keyword kw">end</span>
483: 
484:       <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">at_exit</span> <span class="ruby-keyword kw">do</span>
485:         <span class="ruby-identifier">shutdown</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
486:         <span class="ruby-identifier">reap</span>[<span class="ruby-ivar">@pid</span>] <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
487:       <span class="ruby-keyword kw">end</span>
488: 
489:       <span class="ruby-ivar">@waiter</span> = 
490:         <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> <span class="ruby-keyword kw">do</span>
491:           <span class="ruby-keyword kw">begin</span>
492:             <span class="ruby-ivar">@status</span> = <span class="ruby-constant">Process</span><span class="ruby-operator">::</span><span class="ruby-identifier">waitpid2</span>(<span class="ruby-ivar">@pid</span>).<span class="ruby-identifier">last</span>
493:           <span class="ruby-keyword kw">ensure</span>
494:             <span class="ruby-identifier">reap</span> = <span class="ruby-identifier">lambda</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">cid</span><span class="ruby-operator">|</span> <span class="ruby-value str">'no-op'</span> }
495:           <span class="ruby-keyword kw">end</span>
496:         <span class="ruby-keyword kw">end</span>
497: <span class="ruby-comment cmt">#--}}}</span>
498:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000011" class="method-detail">
        <a name="M000011"></a>

        <div class="method-heading">
          <a href="#M000011" class="method-signature">
          <span class="method-name">gen_psname</span><span class="method-args">(obj)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
generate a <a href="Slave.html#M000002">default</a> name to appear in
ps/top
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000011-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000011-source">
<pre>
     <span class="ruby-comment cmt"># File lib/slave.rb, line 538</span>
538:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">gen_psname</span> <span class="ruby-identifier">obj</span>
539: <span class="ruby-comment cmt">#--{{{</span>
540:       <span class="ruby-node">&quot;slave_#{ obj.class }_#{ obj.object_id }_#{ Process::ppid }_#{ Process::pid }&quot;</span>.<span class="ruby-identifier">downcase</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">%r/\s+/</span>,<span class="ruby-value str">'_'</span>)
541: <span class="ruby-comment cmt">#--}}}</span>
542:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000013" class="method-detail">
        <a name="M000013"></a>

        <div class="method-heading">
          <a href="#M000013" class="method-signature">
          <span class="method-name">getopts</span><span class="method-args">(opts)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
see docs for <a href="Slave.html#M000003">Slave.getopts</a>
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000013-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000013-source">
<pre>
     <span class="ruby-comment cmt"># File lib/slave.rb, line 554</span>
554:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">getopts</span> <span class="ruby-identifier">opts</span> 
555: <span class="ruby-comment cmt">#--{{{</span>
556:       <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">getopts</span> <span class="ruby-identifier">opts</span> 
557: <span class="ruby-comment cmt">#--}}}</span>
558:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000009" class="method-detail">
        <a name="M000009"></a>

        <div class="method-heading">
          <a href="#M000009" class="method-signature">
          <span class="method-name">shutdown</span><span class="method-args">(opts = {})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
cuts the lifeline and kills the child process - give the key
&#8216;quiet&#8217; to ignore errors shutting down, including having
already <a href="Slave.html#M000009">shutdown</a>
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000009-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000009-source">
<pre>
     <span class="ruby-comment cmt"># File lib/slave.rb, line 517</span>
517:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">shutdown</span> <span class="ruby-identifier">opts</span> = {}
518: <span class="ruby-comment cmt">#--{{{</span>
519:       <span class="ruby-identifier">quiet</span> = <span class="ruby-identifier">getopts</span>(<span class="ruby-identifier">opts</span>)[<span class="ruby-value str">'quiet'</span>]
520:       <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;already shutdown&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@shutdown</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">quiet</span>
521:       <span class="ruby-keyword kw">begin</span>; <span class="ruby-constant">Process</span><span class="ruby-operator">::</span><span class="ruby-identifier">kill</span> <span class="ruby-value str">'SIGUSR2'</span>, <span class="ruby-ivar">@pid</span>; <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>; <span class="ruby-keyword kw">end</span>
522:       <span class="ruby-keyword kw">begin</span>; <span class="ruby-ivar">@lifeline</span>.<span class="ruby-identifier">cut</span>; <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span>; <span class="ruby-keyword kw">end</span>
523:       <span class="ruby-identifier">raise</span> <span class="ruby-identifier">e</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">e</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">quiet</span>
524:       <span class="ruby-ivar">@shutdown</span> = <span class="ruby-keyword kw">true</span>
525: <span class="ruby-comment cmt">#--}}}</span>
526:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000010" class="method-detail">
        <a name="M000010"></a>

        <div class="method-heading">
          <a href="#M000010" class="method-signature">
          <span class="method-name">shutdown?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
true
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000010-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000010-source">
<pre>
     <span class="ruby-comment cmt"># File lib/slave.rb, line 530</span>
530:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">shutdown?</span>
531: <span class="ruby-comment cmt">#--{{{</span>
532:       <span class="ruby-ivar">@shutdown</span>
533: <span class="ruby-comment cmt">#--}}}</span>
534:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000014" class="method-detail">
        <a name="M000014"></a>

        <div class="method-heading">
          <a href="#M000014" class="method-signature">
          <span class="method-name">trace</span><span class="method-args">() {|| ...}</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
debugging output - ENV[&#8216;SLAVE_DEBUG&#8217;]=1 to enable
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000014-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000014-source">
<pre>
     <span class="ruby-comment cmt"># File lib/slave.rb, line 562</span>
562:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">trace</span>
563: <span class="ruby-comment cmt">#--{{{</span>
564:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@debug</span> 
565:         <span class="ruby-constant">STDERR</span>.<span class="ruby-identifier">puts</span> <span class="ruby-keyword kw">yield</span>
566:         <span class="ruby-constant">STDERR</span>.<span class="ruby-identifier">flush</span>
567:       <span class="ruby-keyword kw">end</span>
568: <span class="ruby-comment cmt">#--}}}</span>
569:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000007" class="method-detail">
        <a name="M000007"></a>

        <div class="method-heading">
          <a href="#M000007" class="method-signature">
          <span class="method-name">wait</span><span class="method-args">(opts = {})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
<a href="Slave.html#M000007">wait</a> for slave to finish. if the keyword
&#8216;non_block&#8217;=&gt;true is given a thread is returned to do the
waiting in an async fashion. eg
</p>
<pre>
  thread = slave.wait(:non_block=&gt;true){|value| &quot;background &lt;#{ value }&gt;&quot;}
</pre>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000007-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000007-source">
<pre>
     <span class="ruby-comment cmt"># File lib/slave.rb, line 505</span>
505:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">wait</span> <span class="ruby-identifier">opts</span> = {}, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">b</span>
506: <span class="ruby-comment cmt">#--{{{</span>
507:       <span class="ruby-identifier">b</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">lambda</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">exit_status</span><span class="ruby-operator">|</span>}
508:       <span class="ruby-identifier">non_block</span> = <span class="ruby-identifier">getopts</span>(<span class="ruby-identifier">opts</span>)[<span class="ruby-value str">'non_block'</span>]
509:       <span class="ruby-identifier">non_block</span> <span class="ruby-value">? </span><span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span>{ <span class="ruby-identifier">b</span>[ <span class="ruby-ivar">@waiter</span>.<span class="ruby-identifier">value</span> ] } <span class="ruby-operator">:</span> <span class="ruby-identifier">b</span>[ <span class="ruby-ivar">@waiter</span>.<span class="ruby-identifier">value</span> ]
510: <span class="ruby-comment cmt">#--}}}</span>
511:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000008" class="method-detail">
        <a name="M000008"></a>

        <div class="method-heading">
          <span class="method-name">wait2</span><span class="method-args">(opts = {})</span>
        </div>
      
        <div class="method-description">
          <p>
Alias for <a href="Slave.html#M000007">wait</a>
</p>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>